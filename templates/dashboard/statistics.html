{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Dashboard FireBot{% endblock %}

{% block links %}
<link rel="stylesheet" href="{% static 'css/dashboardBase.css' %}">
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<link rel="stylesheet" href="{% static 'css/stats.css' %}">
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://d3js.org/d3-scale-chromatic.v3.min.js"></script>
{% endblock %}

{% block content %}

<!-- Filtr czasu -->
<form id="filterForm" method="get" class="settings-form row">
    <div class="form-group">
        <label>Od:</label>
        <input type="date" name="start_date" value="{{ start_date }}">
    </div>
    <div class="form-group">
        <label>Do:</label>
        <input type="date" name="end_date" value="{{ end_date }}">
    </div>
    <div class="form-group">
        <label>Podział</label>
        <select name="granularity">
            <option value="hour" {% if granularity == 'hour' %}selected{% endif %}>Godzinowy</option>
            <option value="day" {% if granularity == 'day' %}selected{% endif %}>Dniowy</option>
        </select>
    </div>
    <button type="submit" class="save-button">Apply</button>
</form>
{% if not total_attempts %}
    <h2 class="box">Brak statystyk dla wybranego zakresu.</h2>
{% else %}
<!-- Summary cards -->
<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;">
    <div class="card small">Łączna liczba zagrożeń<br/><strong>{{ total_attempts }}</strong></div>
    <div class="card small">Liczba wykrytych ataków<br/><strong>{{ unique_sources }}</strong></div>
    <div class="card small">Szczytowa liczba zagrożeń<br/><strong>{{ peak_count }}</strong></div>
    <div class="card small">Szczytowa godzina<br/><strong>{% if peak_time %}{{ peak_time }}{% else %}-{% endif %}</strong></div>
</div>

    <div class="box linechart">
        <h2>Ataki brute-force w czasie</h2>
        <div id="linechart"></div>
    </div>


<!-- Dodatkowe wykresy: top sources/ports/rules/countries -->

<div class="graphs ">
    <div class="graph box">
        <h2>Podział zagrożeń według kategorii</h2>
        <div id="piechart"></div>
    </div>
    <div class="graph box">
        <h3>Najczęściej atakujące adresy ip</h3>
        <div id="bar-sources"></div>
    </div>
    <div class="graph box">
        <h3>Najczęściej atakowane porty docelowe</h3>
        <div id="bar-ports"></div>
    </div>
    <div class="graph box">
        <h3>Najczęstszą regułą</h3>
        <div id="bar-rules"></div>
    </div>
    <div class="graph box">
        <h3>Kraje najczęsciej atakujące</h3>
        <div id="bar-countries"></div>
    </div>
    <div class="graph box">
        <h3>Najczęściej atakowany adres</h3>
        <div id="bar-dest"></div>
    </div>
</div>
{% endif %}

<script>
/* =========================================================
                1️⃣   DANE Z DJANGO
========================================================= */
const xRaw = JSON.parse('{{ x_time_json|escapejs }}');
const yRaw = JSON.parse('{{ y_time_json|escapejs }}');
const pieData = JSON.parse('{{ pie_json|escapejs }}');
const topSources = JSON.parse('{{ top_sources_json|escapejs }}');
const topPorts = JSON.parse('{{ top_ports_json|escapejs }}');
const topRules = JSON.parse('{{ top_rules_json|escapejs }}');
const topCountries = JSON.parse('{{ top_countries_json|escapejs }}');
const totalAttempts = Number('{{ total_attempts|default:0 }}');
const uniqueSources = Number('{{ unique_sources|default:0 }}');
const peakCount = Number('{{ peak_count|default:0 }}');
const peakTime = '{{ peak_time|default:"" }}';

/* =========================================================
                2️⃣   WYKRES LINIOWY (D3 v7)
========================================================= */
const lineData = xRaw.map((t,i)=>({date: new Date(t), value: yRaw[i]}));

var container = document.getElementById("linechart");

var margin={top:20,right:30,bottom:40,left:80},
    width = container.clientWidth-250,
    height=450;

var svg = d3.select("#linechart").append("svg")
        .attr("width", width+margin.left+margin.right) // extra space for pointer/right padding
    .attr("height", height+margin.top+margin.bottom)
  .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

// Skale
var x = d3.scaleTime().domain(d3.extent(lineData,d=>d.date)).range([0,width]);
var y = d3.scaleLinear().domain([0,d3.max(lineData,d=>d.value)]).range([height,0]);

// Osie
const xAxisG = svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));
xAxisG.selectAll("text").attr("font-size", "15px");
const yAxisG = svg.append("g").call(d3.axisLeft(y));
yAxisG.selectAll("text").attr("font-size", "15px");

// Etykiety osi
svg.append("text")
    .attr("x", (width) / 2)
    .attr("y", height + margin.bottom + 9 )
    .attr("text-anchor", "middle")
    .attr("font-size", "19px")
    .attr("fill", "#333")
    .text("Czas");

svg.append("text")
    .attr("transform", "rotate(-90)")
    .attr("x", - (height / 2))
    .attr("y", -margin.left + 16)
    .attr("text-anchor", "middle")
    .attr("font-size", "19px")
    .attr("fill", "#333")
    .text("Ilość ataków");

// Linia
var line = svg.append("path")
    .datum(lineData)
    .attr("fill","none")
    .attr("stroke","steelblue")
    .attr("stroke-width",2)
    .attr("d", d3.line().x(d=>x(d.date)).y(d=>y(d.value)));

// Pointer elements
var pointerCircle = svg.append("circle")
    .attr("r", 5)
    .attr("fill", "red")
    .style("opacity", 0);

var pointerText = svg.append("text")
    .attr("font-size", 13)
    .attr("fill", "#333")
    .attr("font-weight", "bold")
    .style("opacity", 0);

// Bisector do znajdowania najbliższego punktu
var bisect = d3.bisector(d => d.date).left;

// Obszar interaktywny
svg.append("rect")
    .attr("width", width = container.clientWidth-150,)
    .attr("height", height)
    .style("fill", "none")
    .style("pointer-events", "all")
    .on("mouseover", () => {
        pointerCircle.style("opacity", 1);
        pointerText.style("opacity", 1);
    })
    .on("mouseout", () => {
        pointerCircle.style("opacity", 0);
        pointerText.style("opacity", 0);
    })
    .on("mousemove", function(event) {
        const [mx, my] = d3.pointer(event);
        const date = x.invert(mx);
        const i = bisect(lineData, date, 1);

        // Znajdź najbliższy punkt danych
        const d0 = lineData[i - 1];
        const d1 = lineData[i];
        const d = d1 && (d0 ? date - d0.date > d1.date - date ? d1 : d0 : d1);

        if (!d) return;

        // Aktualizuj pozycję pointera
        pointerCircle
            .attr("cx", x(d.date))
            .attr("cy", y(d.value));

        // Aktualizuj tekst
        pointerText
            .attr("x", x(d.date) + 10)
            .attr("y", y(d.value) - 10)
            .text(`${d.date.toLocaleDateString()} ${d.date.toLocaleTimeString()} → ${d.value}`);
    });

/* =========================================================
        4️⃣   DODATKOWE WYKRESY SŁUPKOWE (Top lists)
   ========================================================= */
function renderBar(container, data, labelKey, valueKey) {
    const w = 420, h = 300, margin = {top: 20, right: 40, bottom: 40, left: 140};
    const svg = d3.select(container).append('svg').attr('width', w).attr('height', h);
    const innerW = w - margin.left - margin.right;
    const innerH = h - margin.top - margin.bottom;
    const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

    const x = d3.scaleLinear().range([0, innerW]).domain([0, d3.max(data, d=>d[valueKey])||1]);
    const y = d3.scaleBand().range([0, innerH]).domain(data.map(d=>d[labelKey])).padding(0.1);

    g.selectAll('rect').data(data).enter().append('rect')
        .attr('x', 0)
        .attr('y', d=>y(d[labelKey]))
        .attr('width', d=>x(d[valueKey]))
        .attr('height', y.bandwidth())
        .attr('fill', 'steelblue');

    // Tooltip pointer for bars
    const tooltip = d3.select(container).append('div').style('position','relative').style('pointer-events','none');
    svg.selectAll('rect')
        .on('mousemove', function(event, d){
            const [mx, my] = d3.pointer(event, this);
            // show small tooltip near mouse
            d3.select(container).selectAll('.bar-tooltip').remove();
            d3.select(container).append('div').attr('class','bar-tooltip')
                .style('position','absolute')
                .style('left',(event.layerX+10)+'px')
                .style('top',(event.layerY+10)+'px')
                .style('background','rgba(0,0,0,0.75)')
                .style('color','white')
                .style('padding','6px 8px')
                .style('border-radius','4px')
                .text(`${d[labelKey]} → ${d[valueKey]}`);
        })
        .on('mouseout', function(){ d3.select(container).selectAll('.bar-tooltip').remove(); });

    g.selectAll('.label').data(data).enter().append('text')
        .attr('x', -8)
        .attr('y', d=>y(d[labelKey]) + y.bandwidth()/2)
        .attr('dy', '0.35em')
        .attr('text-anchor', 'end')
        .text(d=>d[labelKey]);

    g.append('g').attr('transform', `translate(0,${innerH})`).call(d3.axisBottom(x).ticks(4));

    // Dodaj etykiety osi: x -> Ilość ataków, y -> etykieta zależna od typu wykresu
    const yLabelMap = {
        'source': 'Adres źródłowy',
        'port': 'Port docelowy',
        'rule': 'Reguła',
        'country': 'Kraj',
        'destination': 'Adres docelowy'
    };
    const yLabel = yLabelMap[labelKey] || labelKey;

    // X axis label (centered under chart)
    svg.append('text')
        .attr('x', margin.left + innerW / 2)
        .attr('y', h - 6)
        .attr('text-anchor', 'middle')
        .attr('font-size', '16px')
        .attr('fill', '#333')
        .text('Ilość wystąpień');

    // Y axis label (rotated)
    svg.append('text')
        .attr('transform', 'rotate(-90)')
        .attr('x', - (margin.top + innerH / 2))
        .attr('y', 14)
        .attr('text-anchor', 'middle')
        .attr('font-size', '16px')
        .attr('fill', '#333')
        .text(yLabel);
}

renderBar('#bar-sources', topSources, 'source', 'count');
renderBar('#bar-ports', topPorts, 'port', 'count');
renderBar('#bar-rules', topRules, 'rule', 'count');
renderBar('#bar-countries', topCountries, 'country', 'count');
renderBar('#bar-dest', JSON.parse('{{ top_dest_json|default:"[]"|escapejs }}'), 'destination', 'count');

/* =========================================================
                3️⃣   WYKRES KOŁOWY (D3 v7 - POPRAWIONY)
========================================================= */
var widthPie = 450, heightPie = 450, marginPie = 40;
var radius = Math.min(widthPie, heightPie) / 2 - marginPie;

var svgPie = d3.select("#piechart").append("svg")
    .attr("width", widthPie)
    .attr("height", heightPie)
  .append("g")
    .attr("transform", `translate(${widthPie/2}, ${heightPie/2})`);

// D3 v7 - poprawne tworzenie danych dla pie chart
var color = d3.scaleOrdinal().range(d3.schemeSet2);

// Konwersja danych do formatu dla D3 v7
var pieDataFormatted = Object.entries(pieData).map(([key, value]) => ({
    key: key,
    value: value
}));

var pie = d3.pie()
    .value(d => d.value)
    .sort(null);

var arc = d3.arc()
    .innerRadius(0)
    .outerRadius(radius);

// Tworzenie wykresu kołowego
var arcs = svgPie.selectAll('arc')
    .data(pie(pieDataFormatted))
    .enter()
    .append('g')
    .attr('class', 'arc');

// Dodawanie segmentów
arcs.append('path')
    .attr('d', arc)
    .attr('fill', d => color(d.data.key))
    .attr("stroke", "white")
    .style("stroke-width", "2px")
    .style("opacity", 0.8);

// Dodawanie etykiet
arcs.append('text')
    .attr("transform", d => `translate(${arc.centroid(d)})`)
    .attr("text-anchor", "middle")
    .attr("font-size", "13px")
    .attr("font-weight", "bold")
    .attr("fill", "white")
    .text(d => {
        // Pokazuj tylko jeśli segment jest wystarczająco duży
        const percentage = (d.endAngle - d.startAngle) / (2 * Math.PI) * 100;
        return percentage > 5 ? `${d.data.key}: ${d.data.value}` : '';
    });

// Legenda (opcjonalnie)
var legend = svgPie.selectAll('.legend')
    .data(pieDataFormatted)
    .enter()
    .append('g')
    .attr('class', 'legend')
    .attr('transform', (d, i) => `translate(-${widthPie/2}, ${i * 20 - heightPie/3 -30})`);

legend.append('rect')
    .attr('width', 15)
    .attr('height', 15)
    .attr('fill', d => color(d.key));

legend.append('text')
    .attr('x', 20)
    .attr('y', 12)
    .attr('font-size', '13px')
    .text(d => `${d.key}: ${d.value}`);

</script>

{% endblock %}